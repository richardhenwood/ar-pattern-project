<html>
  <head>
    <title>AR Pattern Project</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script>
        delete AFRAME.components["grabbable"];
    </script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.x/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.6/dist/super-hands.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
  </head>
  <body>

    <a-scene
        id="ascene"
        webxr="optionalFeatures: hit-test, bounded-floor; overlayElement: #overlay;"
        xr-mode-ui="XRMode: ar;" 
        background="color: #ECECEC"
        physics="debug: true" 
        obb-collider="showColliders: true">

        <!--a-entity id="leftHand" hand-tracking-grab-controls="hand: left;"></a-entity>
        <a-entity id="rightHand" hand-tracking-grab-controls="hand: right;"></a-entity-->

        <a-entity meta-touch-controls="hand: left" left-thumbstick-logging></a-entity>
        <a-entity meta-touch-controls="hand: right" right-thumbstick-logging></a-entity>


        <a-assets>
            <img id="reference" src="reference_lengths.svg">
            <img id="mypattern" src="male_shirt.svg">
        </a-assets>

        <!--cursor intersection-spawn="event: click; mixin: voxel" raycaster="objects: .grabbable"></a-cursor-->
        
        <a-plane svgplane id="svgplane" 
                default="#reference" 
                src="#reference" 
                class='grabbable' 
                rotation="-90 0 0"
                position="0 0 -1'"
                material="side: double; transparent: true;"
                static-body ></a-plane>

        <!--a-box id='debugbox' position="0 1 -5" rotation="0 45 0" width="0.5" height="0.5" depth="2" color="green">
        </a-box-->

        <a-camera>
            <a-cursor raycaster="objects: .clickable" cursor="rayOrigin: mouse"></a-cursor>
        </a-camera>
        
        <!-- Button in 3D space -->
        <!--a-plane class="clickable" position="0 1 -2" rotation="0 0 0" width="1" height="0.5" color="blue"
            id="rotatebutton">
            <a-text value="Click Me" align="center"></a-text>
        </a-plane-->

        <!--a-plane planerotator id="planerotator" position="0 1 -2" rotation="0 0 0" width="2" height="2" color="blue">
            <a-text value="Click Me" align="center"></a-text>
        </a-plane-->
    </a-scene>

    <script>
        AFRAME.registerComponent('svgplane', {
            schema: {
                svgfile: {type: 'string'},
                width: {type: 'number', default: 1},
                height: {type: 'number', default: 1},
                px2m: {type: 'number', default: 0.0002645833} // convert pixel to meters
            },
            init: function () { },
            update: function () {
                svgfile = this.el.getAttribute('default')
                if (this.data.svgfile) { // we have a new svgfile, so make a new asset
                    svgfile = this.data.svgfile
                }
                /*this.el.setAttribute('material', {
                    shader: 'flat',
                    transparent: true,
                    src: svgfile
                });*/
                //this.el.setAttribute('position', '0 0 -1');
                //this.el.setAttribute('rotation', '-90 0 0');
                const svgdom = document.querySelector(svgfile);
                getSvgDimensions(svgdom.src).then(({width, height}) => {
                    this.el.setAttribute('width', width);
                    this.el.setAttribute('height', height);
                });
            }
        });

        AFRAME.registerComponent('left-thumbstick-logging', {
            init: function () {
                this.el.addEventListener('thumbstickmoved', this.onThumbStickMoved.bind(this));
            },
            onThumbStickMoved: function (evt) {
                const fudge = 0.1;
                const x = evt.detail.x;
                const y = evt.detail.y;
                if (Math.abs(x) > 0.20 && Math.abs(y) > 0.20) { 
                    let svgplane = document.querySelector('#svgplane');
                    let currentRotation = svgplane.getAttribute('position');
                    svgplane.setAttribute('position', {
                        x: currentRotation.x += x * fudge,
                        y: currentRotation.y += y * fudge,
                        z: currentRotation.z
                    });
                }
            }
        });

        AFRAME.registerComponent('right-thumbstick-logging', {
            init: function () {
                this.el.addEventListener('thumbstickmoved', this.onThumbStickMoved.bind(this));
            },
            onThumbStickMoved: function (evt) {
                const xfudge = 3.0;
                const x = evt.detail.x;
                if (Math.abs(x) > 0.1) { 
                    let svgplane = document.querySelector('#svgplane');
                    let currentRotation = svgplane.getAttribute('rotation');
                    svgplane.setAttribute('rotation', {
                        x: currentRotation.x,
                        y: currentRotation.y += x * xfudge,
                        z: currentRotation.z
                    });
                }
            }
        });

        /*AFRAME.registerComponent('positioncontroller', {
            init: function () {
                const el = this.el; // Reference to the entity the component is attached to
                el.setAttribute('material', 'color', 'green'); // Example: Change color when grabbed

                // Listen for the specific grab-start/grab-end events
                el.addEventListener('grab-start', function (evt) {
                    console.log('Entity grabbed!', evt.detail.hand); // evt.detail.hand is the controller/super-hands entity
                    el.setAttribute('material', 'color', 'purple'); // Example: Change color when grabbed
                });

                el.addEventListener('grab-end', function (evt) {
                    console.log('Entity released!', evt.detail.hand);
                    el.setAttribute('material', 'color', 'red'); // Example: Change color back when released
                });

                // Or listen for state changes (more robust for custom logic)
                el.addEventListener('stateadded', function (evt) {
                    if (evt.detail === 'grabbed') {
                        console.log('Grab state added!');
                    }
                });

                el.addEventListener('stateremoved', function (evt) {
                    if (evt.detail === 'grabbed') {
                        console.log('Grab state removed!');
                    }
                });
            }
        });*/

        /*AFRAME.registerComponent('planerotator', {
            init: function () {
                this.el.setAttribute('tracked-controls', 'controller: right'); // Bind to right controller
            },
            tick: function (time, timeDelta) {
                let controller = this.el.components['tracked-controls'].controller;
                if (controller && controller.axes.length > 0) {
                    let yaw = controller.axes[2]; // Example: right thumbstick X-axis
                    let currentRotation = this.el.getAttribute('rotation');
                    // Rotate the plane on its Y-axis (yaw)
                    this.el.setAttribute('rotation', {
                        x: currentRotation.x,
                        y: currentRotation.y + yaw * (timeDelta / 1000) * 50, // Adjust sensitivity
                        z: currentRotation.z
                    });
                }
            }
        });*/

        /*document.querySelector('#rotatebutton').addEventListener('click', function (evt) {
            const svgplane = document.querySelector('#svgplane');
            var rotation = svgplane.getAttribute('rotation');
            // Increment rotation on the Y-axis (degrees)
            svgplane.setAttribute('rotation', { x: rotation.x, y: rotation.y + 21, z: rotation.z });

        });*/

        async function getSvgDimensions(svgUrl) {
            try {
                const response = await fetch(svgUrl);
                const svgString = await response.text();

                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;

                // Try to get width from 'width' attribute
                let width = svgElement.getAttribute('width');
                let height = svgElement.getAttribute('height');

                // If width attribute is missing, check viewBox
                if (!width) {
                    const viewBox = svgElement.getAttribute('viewBox');
                    if (viewBox) {
                        const parts = viewBox.split(' ');
                        // The third value in the viewBox is the width
                        width = parts[2];
                    }
                }

                console.log('Parsed SVG width, height:', width, height);
                if (checkLastTwo(width, 'mm') && checkLastTwo(height, 'mm')){
                    width = parseFloat(width.slice(0, -2)) / 1000;
                    height = parseFloat(height.slice(0, -2)) / 1000;

                    return {width: width, height: height};
                }
                alert("svg file does not have mm measurements in width or height")

            } catch (error) {
                console.error('Error fetching or parsing SVG:', error);
                return null;
            }

            function checkLastTwo(str, expected) {
                // Check if the string has at least two characters before slicing
                if (str.length >= 2) {
                    return str.slice(-2) === expected;
                }
                return false; // Return false for strings shorter than 2 characters
            }
        }
    </script>

    <div id="overlay">
        <div id='url-zone'>Provide a URL to your SVG
            <input type="text" id="url-input" placeholder="Enter file URL here" />
            <button id="submit-url">Submit URL</button>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('url-input');
        const submitUrlBtn = document.getElementById('submit-url');

        submitUrlBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) {
                const assets = document.querySelector('a-assets');
                const asset = document.createElement('img');
                asset.setAttribute('id', 'newpattern');
                asset.setAttribute('src', url);
                assets.appendChild(asset);
                const entity = document.querySelector('#svgplane');
                entity.setAttribute('svgplane', {svgfile: "#newpattern"});
            }
        });
    </script>

  </body>
</html>