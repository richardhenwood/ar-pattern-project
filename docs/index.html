<html>
  <head>
    <title>AR Pattern Project</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.4/dist/aframe-physics-system.min.js"></script>
    <script src=" https://cdn.jsdelivr.net/npm/super-hands@3.0.6/dist/super-hands.min.js "></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
  </head>
  <body>

    <a-scene
        id="ascene"
        webxr="optionalFeatures: hit-test, bounded-floor; overlayElement: #overlay;"
        xr-mode-ui="XRMode: ar;" 
        background="color: #ECECEC"
        physics="debug: true" >
          
        <a-assets>
            <img id="reference" src="reference_lengths.svg">
            <img id="mypattern" src="male_shirt.svg">
        </a-assets>

        <a-entity id="leftHand"
            super-hands
            sphere-collider="objects: .grabbable"
            hand-controls="hand: left">
        </a-entity>

        <a-entity id="rightHand"
            super-hands
            sphere-collider="objects: .grabbable"
            hand-controls="hand: right">
        </a-entity>
        
        <a-cursor intersection-spawn="event: click; mixin: voxel" raycaster="objects: .grabbable"></a-cursor>
        
        <a-plane svgplane id="svgplane" 
                position="0 0 -1"
                rotation="-90 0 0"
                default="#reference" 
                src="#reference" 
                class='grabbable' 
                material="side: double; transparent: true;"
                event-set__hoveron="_event: hover-start; material.opacity: 0.7"
                event-set__hoveroff="_event: hover-end; material.opacity: 1"
                static-body hoverable grabbable></a-plane>
    </a-scene>

    <script>
        AFRAME.registerComponent('svgplane', {
            schema: {
                svgfile: {type: 'string'},
                width: {type: 'number', default: 1},
                height: {type: 'number', default: 1},
                px2m: {type: 'number', default: 0.0002645833} // convert pixel to meters
            },
            init: function () { },
            update: function () {
                svgfile = this.el.getAttribute('default')
                if (this.data.svgfile) { // we have a new svgfile, so make a new asset
                    svgfile = this.data.svgfile
                }
                /*this.el.setAttribute('material', {
                    shader: 'flat',
                    transparent: true,
                    src: svgfile
                });*/
                //this.el.setAttribute('position', '0 0 -1');
                //this.el.setAttribute('rotation', '-90 0 0');
                const svgdom = document.querySelector(svgfile);
                getSvgDimensions(svgdom.src).then(({width, height}) => {
                    this.el.setAttribute('width', width);
                    this.el.setAttribute('height', height);
                });
            }
        });

        async function getSvgDimensions(svgUrl) {
            try {
                const response = await fetch(svgUrl);
                const svgString = await response.text();

                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;

                // Try to get width from 'width' attribute
                let width = svgElement.getAttribute('width');
                let height = svgElement.getAttribute('height');

                // If width attribute is missing, check viewBox
                if (!width) {
                    const viewBox = svgElement.getAttribute('viewBox');
                    if (viewBox) {
                        const parts = viewBox.split(' ');
                        // The third value in the viewBox is the width
                        width = parts[2];
                    }
                }

                console.log('Parsed SVG width, height:', width, height);
                if (checkLastTwo(width, 'mm') && checkLastTwo(height, 'mm')){
                    width = parseFloat(width.slice(0, -2)) / 1000;
                    height = parseFloat(height.slice(0, -2)) / 1000;

                    return {width: width, height: height};
                }
                alert("svg file does not have mm measurements in width or height")

            } catch (error) {
                console.error('Error fetching or parsing SVG:', error);
                return null;
            }

            function checkLastTwo(str, expected) {
                // Check if the string has at least two characters before slicing
                if (str.length >= 2) {
                    return str.slice(-2) === expected;
                }
                return false; // Return false for strings shorter than 2 characters
            }
        }
    </script>

    <div id="overlay">
        <div id='url-zone'>Provide a URL to your SVG
            <input type="text" id="url-input" placeholder="Enter file URL here" />
            <button id="submit-url">Submit URL</button>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('url-input');
        const submitUrlBtn = document.getElementById('submit-url');

        submitUrlBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) {
                const assets = document.querySelector('a-assets');
                const asset = document.createElement('img');
                asset.setAttribute('id', 'newpattern');
                asset.setAttribute('src', url);
                assets.appendChild(asset);
                const entity = document.querySelector('#svgplane');
                entity.setAttribute('svgplane', {svgfile: "#newpattern"});
            }
        });
    </script>

  </body>
</html>