<!DOCTYPE html>
<html>
  <head>
    <title>AR Pattern Project</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script>
    delete AFRAME.components["grabbable"];
    </script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.x/dist/aframe-extras.min.js"></script></script>
    <script src="https://unpkg.com/super-hands@^3.0.6/dist/super-hands.min.js"></script>
    <!--script src="https://unpkg.com/super-hands/dist/super-hands.min.js"></script-->

		<style>
        #drop-zone {
            width: 300px;
            height: 150px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-family: sans-serif;
            color: #666;
            transition: background 0.3s;
						z-index: -10;
        }*/
        #drop-zone.drag-over {
            background: #f0f8ff;
            border-color: #007bff;
        }
        #target-img {
            max-width: 300px;
            display: block;
        }
		</style>

  </head>
  <body style="margin: 0; overflow: hidden;">
    
				<a-scene 
					id="ascene"
					webxr="optionalFeatures: hit-test, bounded-floor; overlayElement: #overlay;"
					xr-mode-ui="XRMode: ar;" 
					ar-hit-test="target:#reference-svg;"
					background="color: #ECECEC">
					
					<a-assets>
						<!--object id="reference-svg" data="reference_lengths.svg" type="image/svg+xml"></object>
						<object id="pattern-svg" data="reference_lengths.svg" type="image/svg+xml"></object-->
						<img id="reference-svg" src="reference_lengths.svg">
						<img id="pattern-svg" src="reference_lengths.svg">
					</a-assets>

				</a-scene>

    	<div id="overlay"><div id='drop-zone'>Drop a new SVG pattern here</div></div>

		<script>
            function set_plane(svgElement) {
            // Create the a-plane
                const px2m = 0.0002645833;
                const scene = document.querySelector('a-scene');
                const referenceSvg = document.getElementById(svgElement);

                const plane = document.getElementById('projection-plane')
                if (plane) {
                    scene.removeChild(plane);
                }

                if (scene && referenceSvg) {
                    const plane = document.createElement('a-plane');
                    plane.setAttribute('id', 'projection-plane');
                    plane.setAttribute('src', '#'+referenceSvg.id);
                    plane.setAttribute('position', '0 0 -1');
                    plane.setAttribute('rotation', '-90 0 0');
                    plane.setAttribute('width', referenceSvg.width*px2m);
                    plane.setAttribute('height', referenceSvg.height*px2m);
                    plane.setAttribute('transparent', 'true');
                    plane.setAttribute('material', 'shader: flat;');
                    plane.setAttribute('grabbable', '');

                    scene.setAttribute('ar-hit-test', referenceSvg);
                    scene.appendChild(plane);
                }
            }
        document.addEventListener('DOMContentLoaded', () => {
            set_plane('reference-svg');

            // Set up the drop zone
            const dropZone = document.getElementById('drop-zone');
            const targetImg = document.getElementById('pattern-svg');

            // 1. Prevent default behavior (Prevent file from opening in a new tab)
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            // 2. Add/Remove visual "drag-over" class
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            // 3. Handle the drop
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                
                if (files.length > 0) {
                    const file = files[0];

                    // Check if the file is actually an image
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();

                        reader.onload = (event) => {
                            // Update the src of the img element
                            targetImg.src = event.target.result;
                            set_plane('pattern-svg');
                        };

                        reader.readAsDataURL(file);
                    } else {
                        alert("Please drop an image file.");
                    }
                }
            });
        });
    </script>

  </body>
</html>
